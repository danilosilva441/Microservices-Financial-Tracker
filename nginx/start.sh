#!/bin/sh
set -e

echo "======================================="
echo "üöÄ Iniciando configura√ß√£o din√¢mica do Nginx"
echo "======================================="

# --- VARI√ÅVEIS OBRIGAT√ìRIAS ---
REQUIRED_VARS="AUTH_SERVICE_HOST AUTH_SERVICE_PORT BILLING_SERVICE_HOST BILLING_SERVICE_PORT ANALYSIS_SERVICE_HOST ANALYSIS_SERVICE_PORT FRONTEND_HOST FRONTEND_PORT"

# Verifica se todas as vari√°veis est√£o definidas
for var in $REQUIRED_VARS; do
  if [ -z "$(eval echo \$$var)" ]; then
    echo "‚ùå ERRO: Vari√°vel de ambiente $var n√£o definida!"
    MISSING_VARS=true
  else
    echo "‚úÖ $var = $(eval echo \$$var)"
  fi
done

# --- CORRE√á√ÉO: Tamb√©m mostra a PORT que ser√° usada ---
echo "‚úÖ PORT = ${PORT:-80}"

if [ "$MISSING_VARS" = true ]; then
  echo "‚ùå Interrompendo: faltam vari√°veis de ambiente obrigat√≥rias."
  exit 1
fi

# --- CORRE√á√ÉO: Adiciona PORT √†s vari√°veis para substitui√ß√£o ---
echo "üîß Gerando configura√ß√£o do Nginx..."
envsubst '${PORT} ${AUTH_SERVICE_HOST} ${AUTH_SERVICE_PORT} ${BILLING_SERVICE_HOST} ${BILLING_SERVICE_PORT} ${ANALYSIS_SERVICE_HOST} ${ANALYSIS_SERVICE_PORT} ${FRONTEND_HOST} ${FRONTEND_PORT}' \
  < /etc/nginx/templates/default.conf.template \
  > /etc/nginx/conf.d/default.conf

echo "‚úÖ Ficheiro /etc/nginx/conf.d/default.conf gerado com sucesso!"
echo "---------------------------------------"

# --- CORRE√á√ÉO: Testa a configura√ß√£o antes de iniciar ---
echo "üîß Testando configura√ß√£o do Nginx..."
nginx -t

echo "======================================="
echo "üöÄ Iniciando configura√ß√£o din√¢mica do Nginx"
echo "======================================="
echo "‚úÖ PORT definida como: $PORT"

echo "üîç Testando conectividade com o frontend..."
if ping -c 3 ${FRONTEND_HOST} &> /dev/null; then
    echo "‚úÖ Conectividade com ${FRONTEND_HOST}: OK"
else
    echo "‚ùå N√£o √© poss√≠vel alcan√ßar ${FRONTEND_HOST}"
fi

# Teste de porta
if nc -z ${FRONTEND_HOST} ${FRONTEND_PORT} &> /dev/null; then
    echo "‚úÖ Porta ${FRONTEND_PORT} no ${FRONTEND_HOST}: OK"
else
    echo "‚ùå Porta ${FRONTEND_PORT} no ${FRONTEND_HOST}: FECHADA"
fi

echo "üîß Gerando configura√ß√£o do Nginx..."
envsubst '${PORT} ${AUTH_SERVICE_HOST} ${AUTH_SERVICE_PORT} ${BILLING_SERVICE_HOST} ${BILLING_SERVICE_PORT} ${ANALYSIS_SERVICE_HOST} ${ANALYSIS_SERVICE_PORT} ${FRONTEND_HOST} ${FRONTEND_PORT}' < /etc/nginx/templates/default.conf.template > /etc/nginx/conf.d/default.conf

echo "‚úÖ Ficheiro /etc/nginx/conf.d/default.conf gerado com sucesso!"

echo "‚úÖ Configura√ß√£o gerada com sucesso!"
echo "üìã Mostrando configura√ß√£o relevante:"
grep -A 5 -B 5 "listen.*${PORT}" /etc/nginx/conf.d/default.conf

echo "üîß Testando configura√ß√£o..."
nginx -t

echo "üöÄ Iniciando Nginx..."
exec nginx -g 'daemon off;'