# ======================================
# üåê API GATEWAY - CONFIG FINAL PRIVADA
# ======================================
# Vers√£o: 2025-10-15
# Ambiente: Private Networking (Railway)
# Fun√ß√£o: Centralizar APIs + Frontend Vue
# ======================================

# --- Servi√ßos Internos ---
upstream auth_service {
    server ${AUTH_SERVICE_HOST}:${AUTH_SERVICE_PORT};
}

upstream billing_service {
    server ${BILLING_SERVICE_HOST}:${BILLING_SERVICE_PORT};
}

upstream analysis_service {
    server ${ANALYSIS_SERVICE_HOST}:${ANALYSIS_SERVICE_PORT};
}

upstream frontend_internal {
    server ${FRONTEND_HOST}:${FRONTEND_PORT};
}

# ==========================
# üîπ Servidor Principal
# ==========================
server {
    listen ${PORT};
    listen [::]:${PORT};
    server_name _;

    access_log /dev/stdout;
    error_log /dev/stderr;

    # --------------------------
    # ‚úÖ HEALTHCHECK (Railway)
    # --------------------------
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy\n";
    }

    # ==========================
    # üî∏ ROTAS DE API
    # ==========================
    location /api/ {
        # --- Headers de Proxy ---
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # --- CORS ---
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,User-Agent,If-Modified-Since,Cache-Control,Range' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$http_origin";
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
            add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,User-Agent,If-Modified-Since,Cache-Control,Range';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # --- Subrotas espec√≠ficas (ORDEM √â IMPORTANTE!) ---
    
        # 1. Analysis Service PRIMEIRO
        location ~ ^/api/analysis {
            proxy_pass http://analysis_service;
        }

        # 2. Auth Service
        location ~ ^/api/(users|token|admin) {
            proxy_pass http://auth_service;
        }

        # 3. Billing Service  
        location ~ ^/api/(billing|operacoes) {
            proxy_pass http://billing_service;
        }


        # --- Rota fallback da API ---
        proxy_pass http://billing_service;
    }

    # ==========================
    # üî∏ FRONTEND SPA (Vue.js)
    # ==========================
    location / {
        proxy_pass http://frontend_internal;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # üîÅ Fallback SPA para rotas do Vue Router
        error_page 404 = /index.html;

        # üîí Seguran√ßa adicional
        add_header Cache-Control "no-cache";
        add_header Pragma "no-cache";
        add_header Expires 0;

        # Caso o frontend esteja offline, mostra mensagem padr√£o
        proxy_intercept_errors on;
        error_page 502 503 504 =503 @frontend_offline;
    }

    # ==========================
    # üî∏ ERRO: FRONTEND OFFLINE
    # ==========================
    location @frontend_offline {
        default_type text/html;
        return 503 '
            <html>
                <head><title>Servi√ßo Temporariamente Indispon√≠vel</title></head>
                <body style="font-family:sans-serif;text-align:center;margin-top:20vh;">
                    <h2>üöß O frontend est√° temporariamente indispon√≠vel.</h2>
                    <p>Tente novamente em alguns minutos.</p>
                </body>
            </html>';
    }

    # ==========================
    # üî∏ SEGURAN√áA E PERFORMANCE
    # ==========================
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";

    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    send_timeout 30s;

    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
}